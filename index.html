<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incremental Game Save Editor</title>
    <link rel="stylesheet" href ="styles.css">
</head>
<body>
    <div class="container">
        <h1>Incremental Game Save Editor</h1>
        <p class="subtitle">Decode, edit, and re-encode your game save files (in Base64)<br>I DON'T CONDONE CHEATING</p>

        <div class="section">
            <label for="encodedInput">Paste your Base64 encoded save here:</label>
            <textarea id="encodedInput" placeholder="Paste your base64 save data here..."></textarea>
            <div class="error" id="decodeError">Error parsing save. Is your save corrupt?</div>
        </div>

        <div class="section">
            <button id="decodeButton">Decode to JSON</button>
        </div>

        <div class="section">
            <h2>Select JSON display style:</h2>
            <input type="radio" id="rawStyle" name="displayStyle" value="rawStyle" checked />
            <label for="rawStyle" ">Raw</label>
            <input type="radio" id="listStyle" name="displayStyle" value="listStyle" />
            <label for="listStyle">List</label>
        </div>
        
        <div class="section">
            <label for="jsonOutputRaw">Edit your save data (JSON):</label>
        </div>

        <div class="section">
            <div class="tab" id="tab" style="display: none;"></div>
        </div>
        
        <div class="section">
            <textarea id="jsonOutputList" placeholder="Decoded JSON will appear here..." style="display: none;"></textarea>
        </div>

        <div class="section">
            <textarea id="jsonOutputRaw" placeholder="Decoded JSON will appear here..."></textarea>
            <div class="error" id="jsonError">Error parsing JSON. Make sure the JSON is correctly formatted!</div>
        </div>

        <div class="section">
            <button id="encodeButton">Encode to Base64</button>
            <button id="copyButton">Copy to Clipboard</button>
        </div>

        <div class="section">
            <label for="encodedOutput">Base64 encoded save (ready to paste back into game):</label>
            <textarea id="encodedOutput" placeholder="Encoded save will appear here..." readonly></textarea>
            <div class="success" id="copySuccess">Copied to Clipboard!</div>
        </div>
    </div>

    <script>
        const elements = {
            encodedInput: document.getElementById('encodedInput'),
            jsonOutputRaw: document.getElementById('jsonOutputRaw'),
            encodedOutput: document.getElementById('encodedOutput'),
            decodeButton: document.getElementById('decodeButton'),
            encodeButton: document.getElementById('encodeButton'),
            copyButton: document.getElementById('copyButton'),
            decodeError: document.getElementById('decodeError'),
            jsonError: document.getElementById('jsonError'),
            copySuccess: document.getElementById('copySuccess'),
            rawStyleButton: document.getElementById('rawStyle'),
            listStyleButton: document.getElementById('listStyle'),
            jsonOutputList: document.getElementById('jsonOutputList'),
            tabs: document.getElementById('tab')
        };

        // Decode function
        elements.decodeButton.addEventListener('click', () => {
            let input = elements.encodedInput.value;            
            let decoded;
            try {
                decoded = atob(input);
            } catch (err) { // occurs with malformed input
                elements.decodeError.style.display = 'block';
                console.log('Error parsing save. ' + err);
                return;
            }
            let parsed = JSON.parse(decoded);
            elements.jsonOutputRaw.value = JSON.stringify(parsed, null, 2);
            elements.decodeError.style.display = 'none';

            updateTabs(parsed);
        });

        // Encode function
        elements.encodeButton.addEventListener('click', () => {
            let parsed;
            let input = elements.jsonOutputRaw.value;
            let json = JSON.parse(input);
            if (elements.listStyleButton.checked) { // handles list style
                let change = elements.jsonOutputList.value; // find the user changes
                let index; // becomes the title of the tab, which is same as the JSON key
                document.querySelectorAll('.tablinks').forEach(btn => {
                    if (btn.classList.contains('active')) {
                        index = btn.textContent;
                    }
                })
                try {
                    parsed = JSON.parse(change); // parses the user change into JSON
                } catch (err) { // occurs with malformed JSON
                    elements.jsonError.style.display = 'block';
                    console.log('Error parsing JSON. ' + err);
                    return;
                }
                json[index] = parsed; // replace specific entry with the updated value
                parsed = json; // puts it into parsed so the final function can work
            } else { // handles raw style
                try {
                    parsed = JSON.parse(input); // check if it can just be simply converted back
                } catch (err) { // occurs with malformed JSON
                    elements.jsonError.style.display = 'block';
                    console.log('Error parsing JSON. ' + err);
                    return;
                }
            }
            let encoded = btoa(JSON.stringify(parsed));
            elements.encodedOutput.value = encoded;
            elements.jsonError.style.display = 'none';
        });

        // Copy to clipboard function
        elements.copyButton.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(elements.encodedOutput.value);
                elements.copySuccess.style.display = 'block';
                elements.copySuccess.style.opacity = '1';
                console.log('Save copied to clipboard');
                setTimeout(() => { // lil fade
                    elements.copySuccess.style.transition = 'opacity 1s';
                    elements.copySuccess.style.opacity = '0';
                    setTimeout(() => {
                        elements.copySuccess.style.display = 'none';
                    }, 1000); 
                }, 1000);
            } catch (err) { 
                console.log('Error copying save to clipboard. ' + err);
                elements.copySuccess.style.display = 'none';
            }
        });

        // json tabs

        // called when tab is clicked, just copies the value into the box
        function openTab(tabName) {
            elements.jsonOutputList.value = JSON.stringify(JSON.parse(elements.jsonOutputRaw.value)[tabName], null, 2);
        }
        
        function updateTabs(jsonOutputRaw) {
            const tabContainer = document.querySelector('.tab');
            tabContainer.textContent = '';
            document.querySelectorAll('.tabcontent').forEach(el => el.remove());

            // create button for each key/index and add behaviour
            if (elements.listStyleButton.checked) {
                Object.keys(jsonOutputRaw).forEach((key, index) => {
                    const button = document.createElement('button');
                    button.className = 'tablinks';
                    button.textContent = key;
                    button.onclick = () => { // make new active by removing all and adding one
                        document.querySelectorAll('.tablinks').forEach(btn => {
                            btn.classList.remove('active');
                        })
                        button.classList.add('active');
                        openTab(key);
                    }
                    tabContainer.appendChild(button);
                })
            }
        }

        elements.rawStyleButton.addEventListener('click', () => {
            // hide list, show raw
            elements.jsonOutputRaw.style.display = 'block';
            elements.tabs.style.display = 'none';
            elements.jsonOutputList.style.display = 'none';

            try {
                updateTabs(JSON.parse(elements.jsonOutputRaw.value));
            } catch (err) { 
                console.log('No data to update tabs');
            }
        })
        
        elements.listStyleButton.addEventListener('click', () => {
            // hide raw, show list
            elements.jsonOutputRaw.style.display = 'none';
            elements.tabs.style.display = 'block';
            elements.jsonOutputList.style.display = 'block';

            try {
                updateTabs(JSON.parse(elements.jsonOutputRaw.value));

                // autoselect first tab
                const firstButton = document.querySelector('.tablinks'); 
                if (firstButton) firstButton.click();
            } catch (err) {
                console.log('No data to update tabs');
            }
        })
    </script>
</body>

</html>
